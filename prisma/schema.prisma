generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  passwordHash  String   @map("password_hash")
  displayName   String   @map("display_name")
  createdAt     DateTime @default(now()) @map("created_at")
  currentStreak Int      @default(0) @map("current_streak")
  lastQuizDate  DateTime? @map("last_quiz_date")
  longestStreak Int      @default(0) @map("longest_streak")
  lastSubjectId String?  @map("last_subject_id")

  categories         Category[]
  quizzes            Quiz[]
  attempts           Attempt[]
  assessments        Assessment[]
  userSubjectLevels  UserSubjectLevel[]
  sessions           Session[]
  subtopicQuestions  SubtopicQuestion[]
  dailyLevelScores   DailyLevelScore[]
  lastSubject        Subject? @relation("LastSubject", fields: [lastSubjectId], references: [id])
  lessonProgress     LessonProgress[]
  goDeepers          GoDeeper[]

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Subject {
  id        String @id @default(uuid())
  name      String @unique
  icon      String
  sortOrder Int    @map("sort_order")

  levels            Level[]
  categories        Category[]
  assessments       Assessment[]
  userSubjectLevels UserSubjectLevel[]
  questions         Question[]
  usersLastSubject  User[] @relation("LastSubject")

  @@map("subjects")
}

model Level {
  id        String @id @default(uuid())
  subjectId String @map("subject_id")
  name      String
  sortOrder Int    @map("sort_order")

  subject                    Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  categories                 Category[]
  userSubjectLevelsCurrent   UserSubjectLevel[] @relation("CurrentLevel")
  userSubjectLevelsSuggested UserSubjectLevel[] @relation("SuggestedLevel")
  assessmentsSuggested       Assessment[]
  questions                  Question[]
  subtopics                  Subtopic[]
  dailyLevelScores           DailyLevelScore[]

  @@unique([subjectId, name])
  @@map("levels")
}

model Category {
  id        String   @id @default(uuid())
  subjectId String   @map("subject_id")
  levelId   String   @map("level_id")
  topicName String   @map("topic_name")
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  level   Level   @relation(fields: [levelId], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  quizzes Quiz[]

  @@map("categories")
}

model Quiz {
  id               String   @id @default(uuid())
  categoryId       String   @map("category_id")
  subtopicId       String?  @map("subtopic_id")
  questions        String   // JSON string
  questionCount    Int      @map("question_count")
  timeLimitMinutes Int?     @map("time_limit_minutes")
  createdBy        String   @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")

  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subtopic Subtopic? @relation(fields: [subtopicId], references: [id])
  creator  User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  attempts Attempt[]

  @@map("quizzes")
}

model Attempt {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  quizId         String   @map("quiz_id")
  isFirstAttempt Boolean  @map("is_first_attempt")
  score          Int
  totalQuestions Int      @map("total_questions")
  answers        String   // JSON string
  timeTakenSeconds Int?   @map("time_taken_seconds")
  completedAt    DateTime @default(now()) @map("completed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("attempts")
}

model Assessment {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  subjectId        String   @map("subject_id")
  questions        String   // JSON string
  answers          String?  // JSON string, null until submitted
  scoreByLevel     String?  @map("score_by_level") // JSON string
  suggestedLevelId String?  @map("suggested_level_id")
  completedAt      DateTime? @map("completed_at")
  createdAt        DateTime @default(now()) @map("created_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject        Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  suggestedLevel Level?   @relation(fields: [suggestedLevelId], references: [id])

  @@map("assessments")
}

model UserSubjectLevel {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  subjectId        String    @map("subject_id")
  currentLevelId   String    @map("current_level_id")
  suggestedLevelId String?   @map("suggested_level_id")
  lastAssessedAt   DateTime? @map("last_assessed_at")

  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject        Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  currentLevel   Level   @relation("CurrentLevel", fields: [currentLevelId], references: [id])
  suggestedLevel Level?  @relation("SuggestedLevel", fields: [suggestedLevelId], references: [id])

  @@unique([userId, subjectId])
  @@map("user_subject_levels")
}

model Question {
  id            String   @id @default(uuid())
  subjectId     String   @map("subject_id")
  levelId       String   @map("level_id")
  question      String
  options       String   // JSON array of 4 options
  correctAnswer String   @map("correct_answer")
  explanation   String
  createdAt     DateTime @default(now()) @map("created_at")

  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  level   Level   @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model Subtopic {
  id        String @id @default(uuid())
  levelId   String @map("level_id")
  name      String
  prompt    String // Fixed prompt for AI question generation
  sortOrder Int    @map("sort_order")

  level     Level              @relation(fields: [levelId], references: [id], onDelete: Cascade)
  quizzes   Quiz[]
  questions SubtopicQuestion[]
  lessons   Lesson[]

  @@unique([levelId, name])
  @@map("subtopics")
}

model SubtopicQuestion {
  id              String   @id @default(uuid())
  subtopicId      String   @map("subtopic_id")
  userId          String   @map("user_id")
  questionId      String   @map("question_id") // e.g., "q1", "q2" within a quiz
  quizId          String   @map("quiz_id")
  isCorrect       Boolean  @map("is_correct")
  answeredAt      DateTime @default(now()) @map("answered_at")
  questionHash    String?  @map("question_hash")      // SHA-256 hash for deduplication
  questionText    String?  @map("question_text")      // Full question text
  difficultyLevel Int      @default(1) @map("difficulty_level") // 1-4 scale

  subtopic Subtopic @relation(fields: [subtopicId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, subtopicId, answeredAt])
  @@index([userId, subtopicId, questionHash])
  @@map("subtopic_questions")
}

model DailyLevelScore {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  levelId        String   @map("level_id")
  date           DateTime @db.Date
  avgScore       Float    @map("avg_score")
  subtopicScores String   @map("subtopic_scores") // JSON: { subtopicId: score }

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@unique([userId, levelId, date])
  @@index([userId, levelId, date])
  @@map("daily_level_scores")
}

model Lesson {
  id           String   @id @default(uuid())
  subtopicId   String   @map("subtopic_id")
  title        String
  introduction String
  content      String   // JSON: { sections: [{heading, content, examples}] }
  keyTakeaways String   @map("key_takeaways") // JSON: string[]
  sortOrder    Int      @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  subtopic  Subtopic         @relation(fields: [subtopicId], references: [id], onDelete: Cascade)
  progress  LessonProgress[]
  goDeepers GoDeeper[]

  @@unique([subtopicId, sortOrder])
  @@map("lessons")
}

model LessonProgress {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  lessonId    String    @map("lesson_id")
  completed   Boolean   @default(false)
  quizScore   Int?      @map("quiz_score")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, lessonId])
  @@map("lesson_progress")
}

model GoDeeper {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  lessonId   String   @map("lesson_id")
  userPrompt String   @map("user_prompt")
  aiResponse String   @map("ai_response")
  isRelevant Boolean  @map("is_relevant")
  createdAt  DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId, lessonId])
  @@map("go_deeper")
}
